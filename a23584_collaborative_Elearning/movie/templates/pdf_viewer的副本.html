<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer</title>
<script src="{{ url_for('static', filename='pdf.min.js') }}"></script>
<script src="{{ url_for('static', filename='pdf.worker.min.js') }}"></script>

<!-- <link rel='stylesheet'src="{{ url_for('static', filename='pdf_viewer.css') }}"> -->
   <link rel='stylesheet' href='/static/bootstrap-4.5.2-dist/css/bootstrap.min.css'>
<script src="/static/jquery-3.5.1.min.js"></script>

<style>
    #pdf-container {
        width: 70%;
        overflow: auto;
        float: left;
        position: relative;
    }
    .page-container {
        position: relative;
        display: inline-block;
        margin-bottom: 10px;
    }
    canvas {
        display: block;
        background-color: #f0f0f0;
    }
    #comment-section {
        position: fixed;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
    }

    .comment-label {
        position: absolute;
        color: blue;
        font-weight: bold;
        background-color: pink;
        border: 2px solid red;
        padding: 5px;
        white-space: nowrap;
    }
</style>



</head>
<body>
    <h1>{{ filename }}</h1>
    <div id="pdf-container"></div>
    <div id="comment-section">
        <textarea id="comment" placeholder="Leave your comment here..."></textarea>
        <br/>
        <button id="save-comment" class="btn btn-primary">Save Comment</button>
    </div>

<script>
    let currentPageNum = 1;
    const pdfPath = "/pdf_files/java_tutorial.pdf";
    pdfjsLib.getDocument(pdfPath).promise.then(function (pdf) {
        const container = document.getElementById('pdf-container');
        const renderPage = function (pageNum) {
            pdf.getPage(pageNum).then(function (page) {
                const scale = 1.5;
                const viewport = page.getViewport({ scale: scale });

                const pageContainer = document.createElement('div');
                pageContainer.className = 'page-container';
                container.appendChild(pageContainer);

                const canvas = document.createElement('canvas');
                pageContainer.appendChild(canvas);

                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                page.render(renderContext);

                currentPageNum = pageNum;
            });
        }

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            renderPage(pageNum);
        }
    });

    document.getElementById('save-comment').addEventListener('click', function () {
        const commentText = document.getElementById('comment').value;

        if (commentText.trim() !== '') {
            const commentLabel = document.createElement('div');
            commentLabel.classList.add('comment-label');
            commentLabel.textContent = commentText;

            const container = document.getElementById('pdf-container');
            const commentSection = document.getElementById('comment-section');
            const commentRect = commentSection.getBoundingClientRect();


            const currentPageContainer = container.querySelector(`.page-container:nth-of-type(${currentPageNum})`);
            const containerRect = currentPageContainer.getBoundingClientRect();
            const labelTop = commentRect.top - containerRect.top + container.scrollTop;
            const labelLeft = container.clientWidth - containerRect.left + 10;

            commentLabel.style.top = labelTop + 'px';
            commentLabel.style.left = labelLeft + 'px';

            currentPageContainer.appendChild(commentLabel);





            fetch('/save_comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'comment': commentText,
                    'page': currentPageNum,
                    'x': parseInt(commentLabel.style.left),
                    'y': parseInt(commentLabel.style.top)
                })
            })
                .then(function (response) {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Server response was not OK');
                    }
                })
                .then(function (data) {
                    console.log('Comment saved:', data);
                })
                .catch(function (error) {
                    console.error('Error saving comment:', error);
                });

            document.getElementById('comment').value = '';
        }
    });
</script>

</body>
</html>
